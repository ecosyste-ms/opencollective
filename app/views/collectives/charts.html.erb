<div class="container-md">
  <h3>Top 1000 Collectives with most donated</h3>

  <%= column_chart @collectives_by_total_donations, thousands: ",", colors: ["#7878EF"] %>

  <h3>Top 50 Collectives with most donated<h3>

  <%= column_chart @top_50_collectives_by_total_donations, thousands: ",", colors: ["#7878EF"] %>

<% @ecosystems.each do |ecosystem| %>
  
  <% ecosystem_packages = @critical_packages.select { |pkg| pkg['downloads'] && pkg['downloads'] > 0 }.select { |pkg| pkg['ecosystem'] == ecosystem } %>
  <% if ecosystem_packages.length > 5 %>

  <h3>Ecosystem: <%= ecosystem %></h3>
  
<%= column_chart [
  { 
    name: "Downloads", 
    data: ecosystem_packages
      .select { |pkg| pkg['downloads'] && pkg['downloads'] > 0 }
      .sort_by { |pkg| -pkg['downloads'] }.first(100)
      .map { |pkg| [pkg['name'], pkg['downloads']] }
      .to_h,
    library: { yAxisID: "y", backgroundColor: "#7878EF", borderColor: "#7878EF" }
  },
  { 
    name: "Funding (Scaled)", 
    data: ecosystem_packages
      .select { |pkg| pkg['downloads'] && pkg['downloads'] > 0 }
      .sort_by { |pkg| -pkg['downloads'] }.first(100)
      .map { |pkg|
        osc_slug = pkg['funding_links']
          .select { |l| l.include?('opencollective.com') }
          .first
          &.split('/')&.last&.split('#')&.first
        collective = Collective.find_by_slug(osc_slug.to_s.downcase)
        total_donations = collective&.total_donations.to_i # Convert nil to 0
        [pkg['name'], total_donations * 1000] # Scale funding for visibility
      }
      .to_h,
    library: { yAxisID: "y2", backgroundColor: "#45E56E", borderColor: "#45E56E" }
  }
], library: {
  scales: {
    y:  { 
      id: "y", 
      position: "left", 
      ticks: { beginAtZero: true }, 
      scaleLabel: { display: true, labelString: "Downloads" } 
    },
    y2: { 
      id: "y2", 
      position: "right", 
      type: "linear", 
      ticks: { 
        beginAtZero: true, 
        min: 0, 
        suggestedMax: 1_000_000, # Adjust based on actual donation values
        callback: "function(value) { return '$' + (value / 1000) + 'k'; }"
      }, 
      scaleLabel: { display: true, labelString: "Funding ($)" } 
    }
  }
} %>

<% end %>

<%end %>

</div>